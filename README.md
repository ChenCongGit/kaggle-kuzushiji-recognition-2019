# Kaggle Kuzushiji Recognition
[Kaggle Kuzushiji Recognition](https://www.kaggle.com/c/kuzushiji-recognition/overview)比赛代码，最终成绩「15/295」，F值90.0％

## Overview
该项目对下图这种常见的古日文手写体书写的古籍进行逐字翻译，转录为现代日文文字表示，并且尽可能保证转录字符的位置正确。整个项目的主要流程包括文字非文字检测和具体文字类别分类。
![](/相关图片/日文古籍.jpg "日文古籍")
![](/相关图片/可视化转录结果.jpg "可视化转录结果")

### 数据构成
我们共有8031张古籍文献图像，每一张图像是古籍的一页，文字从右到左纵向排列。其中3881张用作训练集，我们挑选其中的3104张作为目标检测网络训练集，777张作为目标检测网络验证集，用于优化检测网络超参数。我们将3104张古籍图像的所有文字裁剪下来作为文字识别（分类）网络的数据集，大约54万张，我们挑选其中的53万张作为文字识别网络训练集，剩下的1万多张作为文字识别网络验证集，用于优化识别网络超参数。另外的4150张古籍文献图像用作最终公共测试集，进行算法评估。

### 算法细节
检测过程和文字分类过程分离。
 - 文字非文字检测过程比较容易，而文字分类过程非常困难，传统检测算法更加侧重于检测框回归，对难度非常大的检测区域分类效果不如单独的分类网络。
 - 不同类别文字数量极度不均衡，可能相差数千倍，采用单一的目标检测网络很难对不同类别的字符进行类别均衡。

## 检测

我们采用YOLO V3网络进行文字检测，代码参考[https://github.com/YunYang1994/tensorflow-yolov3](https://github.com/YunYang1994/tensorflow-yolov3)，进行了一些改动

算法细节：

* 增加了色度、饱和度、亮度的随机调整，去除了随机翻转和平移的预处理。
* 因为一张图片中的文字较多，增加了随机裁剪处理，裁剪原图大小的1/2-1的图片进行训练。
* 因为检测框相对整张图片面积较小（只包含一个字），训练和测试时使用较大的尺寸，其中测试时使用1024大小。

在验证集上，IOU＝0.5时，mAP=0.99；IOU＝0.7时，mAP＝0.91。

## 识别
我们采用ResNet网络作为文字分类的主要模型。下图是一些文字图像:
![](/相关图片/文字1.jpg "文字1")
![](/相关图片/文字2.jpg "文字2")

算法细节:
 - 原始文字标签检测框适当膨胀并随机裁剪。由于采用两阶段算法，检测时检测框预测不准确将会影响识别结果，因此我们采用膨胀并随机裁剪在训练时尽可能拟合检测过程检测不准确的影响。该方法在4150张测试集上提高了大约5%的F-score值。
 - 文字图像padding0到宽和高的最大值，并resize到128*128大小。文字图像可能是任意大小，任意宽高比，为了统一大小并且不改变文字原有形状，对他进行padding，并且resize到统一的128大小，128也可能不是最好的尺寸，还有待调试。实际上，如果网络采用多尺度集成训练，理论上应该会有更高的准确率，如(64，96，128)。
 - 数据集类别均衡。我们注意到训练集中不同类别的文字数量差异很大，最多的有24685个，最少的只有1个，类别严重不均衡。我们采用指数文字复制，对每一个类别的样本复制m次: m = (MAX/min(MAX, num))^EXP，其中MAX为复制类别上限，EXP为复制指数，num为该类别样本数。我们取MAX=2000，EXP=1.0。另外对于样本数过于少的类别（num<=10）直接忽略。
 - 批量分类。我们以一整张文献图像中的所有文字为一个batch，同时进行分类，有效的提高推理速度。
 - 推理时根据置信阈值适当删除一些检测框。当识别分类时，该区域所有类别的置信度都不高时，很有可能是目标检测过程检测错误，我们提出该检测框以提高精度P。

在1万多张图片验证集上，识别准确率97.6%（包括省略掉的类别），在777张检测验证集上结合最好的检测模型验证F值94.86%。

## 代码程序
### 生成识别数据集
1. 裁剪并划分数据集
```
python ./utils/crop_char_image.py
```
2. 类别均衡增强
```
python ./utils/data_augmentation.py
```
### 训练
```
CUDA_VISIBLE_DEVICES = 0 python ./recognition/train_imagenet.py
```
### 测试（单张推理）
```
CUDA_VISIBLE_DEVICES = 0 python ./recognition/demo.py
```
### 批量推理
```
CUDA_VISIBLE_DEVICES = 0 python ./recognition/batch_demo.py
```
